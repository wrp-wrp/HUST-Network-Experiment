# 网络实验自动化测试套件

## 概述

本测试套件用于自动化测试华中科技大学网络实验中的三种传输协议：
- **GBN (Go-Back-N)** 协议
- **SR (Selective Repeat)** 协议  
- **TCP** 简化版协议

测试套件完全满足实验要求，包含以下测试内容：

## 测试内容

### 第一级测试 (50分)

#### 1-1 GBN协议正确性 (45分)
- 运行程序10次
- 验证每次运行的输出文件内容是否完全一致
- 确保协议实现的确定性和正确性

#### 1-2 GBN滑动窗口移动正确性 (5分)
- 捕获每次滑动窗口移动的控制台输出
- 将输出重定向到文件
- 验证窗口移动逻辑的正确性

### 第二级测试 (30分)

#### 2-3 SR协议正确性 (25分)
- 运行程序10次
- 验证每次运行的输出文件内容是否完全一致
- 确保选择重传协议的正确性

#### 2-4 SR滑动窗口移动正确性 (5分)
- 捕获每次滑动窗口移动的控制台输出
- 将输出重定向到文件
- 验证选择重传窗口移动的正确性

### 第三级测试 (20分)

#### 3-5 TCP协议正确性 (10分)
- 运行程序10次
- 验证每次运行的输出文件内容是否完全一致
- 确保TCP协议实现的正确性

#### 3-6 TCP滑动窗口移动正确性 (5分)
- 捕获每次滑动窗口移动的控制台输出
- 将输出重定向到文件
- 验证TCP窗口移动的正确性

#### 3-7 TCP快速重传正确性 (5分)
- 检测快速重传事件的触发
- 捕获并记录重复ACK和快速重传信息
- 验证快速重传机制的正确性

## 使用方法

### 1. 基本使用

```bash
# 运行完整测试套件
./test_suite.sh
```

### 2. 查看测试结果

测试完成后，结果会保存在 `test_results/` 目录下，按时间戳组织：

```
test_results/
└── 20250101_123456/           # 时间戳目录
    ├── test_report.txt        # 总测试报告
    ├── gbn_correctness/       # GBN正确性测试结果
    │   ├── output_1.txt       # 第1次运行输出
    │   ├── output_2.txt       # 第2次运行输出
    │   └── ...
    ├── gbn_window/            # GBN窗口测试结果
    │   ├── window_output.txt  # 完整输出
    │   └── window_movements.txt # 窗口移动记录
    ├── sr_correctness/        # SR正确性测试结果
    ├── sr_window/             # SR窗口测试结果
    ├── tcp_correctness/       # TCP正确性测试结果
    ├── tcp_window/            # TCP窗口测试结果
    └── tcp_fast_retransmit/   # TCP快速重传测试结果
        ├── fast_retransmit_output.txt
        └── fast_retransmit_events.txt
```

### 3. 查看测试报告

```bash
# 查看最新的测试报告
cat test_results/*/test_report.txt | tail -50
```

### 4. 查看窗口移动详情

```bash
# 查看GBN窗口移动
cat test_results/*/gbn_window/window_movements.txt

# 查看SR窗口移动
cat test_results/*/sr_window/window_movements.txt

# 查看TCP窗口移动
cat test_results/*/tcp_window/window_movements.txt
```

### 5. 查看快速重传事件

```bash
# 查看TCP快速重传事件
cat test_results/*/tcp_fast_retransmit/fast_retransmit_events.txt
```

## 测试报告示例

```
==========================================
        网络实验自动化测试报告
==========================================
测试时间: 20250101_123456
测试目录: test_results/20250101_123456

==========================================
           测试结果摘要
==========================================

第一级 (50分):
----------------------------------------
1-1 GBN协议正确性           : PASS (45分)
1-2 GBN滑动窗口移动         : PASS (5分)

第二级 (30分):
----------------------------------------
2-3 SR协议正确性            : PASS (25分)
2-4 SR滑动窗口移动          : PASS (5分)

第三级 (20分):
----------------------------------------
3-5 TCP协议正确性           : PASS (10分)
3-6 TCP滑动窗口移动         : PASS (5分)
3-7 TCP快速重传             : PASS (5分)

==========================================
总测试数: 7
通过数: 7
失败数: 0
总得分: 100/100
==========================================
```

## 前置要求

1. 确保项目已正确编译：
```bash
cd build
make
cd ..
```

2. 确保 `input.txt` 文件存在

3. 确保以下可执行文件存在：
   - `bin/gbn`
   - `bin/sr`
   - `bin/tcp`

## 注意事项

1. **测试时间**：完整测试套件需要运行所有协议各10次，可能需要几分钟时间

2. **输出重定向**：所有控制台输出都会被重定向到对应的日志文件中

3. **快速重传**：TCP快速重传测试依赖于网络模拟器的配置，如果网络条件不触发丢包或重复ACK，可能检测不到快速重传事件

4. **确定性**：测试要求程序运行结果具有确定性，即相同输入产生相同输出

## 故障排查

### 问题1：编译失败
```bash
cd build
cmake ..
make clean
make
cd ..
```

### 问题2：测试结果不一致
检查网络模拟器的随机种子设置，确保使用固定的随机种子以获得确定性结果。

### 问题3：未检测到窗口移动
确认代码中包含窗口移动的输出语句：
- GBN: `std::cout << "[GBN] 滑动窗口: ..."`
- SR: `std::cout << "[SR] 滑动前窗口: ..."` 和 `"[SR] 滑动后窗口: ..."`
- TCP: `std::cout << "[TCP] 滑动窗口: ..."`

### 问题4：未检测到快速重传
确认TCP代码中包含快速重传的输出语句：
- `std::cout << "[TCP] 快速重传触发: ..."`
- `pUtils->printPacket("TCP发送方收到3个重复ACK，快速重传", ...)`

## 自定义测试

如果需要修改测试参数（如运行次数），可以编辑 `test_suite.sh` 中的 `run_count` 变量：

```bash
# 在各测试函数中修改
local run_count=10  # 改为所需的运行次数
```

## 联系与支持

如有问题或建议，请参考项目文档或联系实验指导教师。

## 更新日志

- 2025-10-01: 初始版本，支持GBN、SR、TCP全部测试要求
