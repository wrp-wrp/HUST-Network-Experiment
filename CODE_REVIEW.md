# 代码正确性检查报告

## 检查日期
2025年10月1日

## 检查的协议
1. GBN (Go-Back-N)
2. SR (Selective Repeat)
3. TCP (带快速重传的滑动窗口)

---

## 一、GBN协议检查

### ✅ 发送方 (GbnRdtSender.cpp)
- **窗口管理**: 正确实现了滑动窗口，窗口大小为4
- **累积确认**: 正确处理累积ACK，收到ACK(n)时确认所有≤n的包
- **超时重传**: 正确实现，超时时重发窗口内所有未确认的包
- **定时器管理**: 只为base包维护一个定时器
- **滑动窗口输出**: ✅ 已添加，每次窗口滑动时输出窗口内容

### ✅ 接收方 (GbnRdtReceiver.cpp)
- **按序接收**: 只接收期望序号的包
- **累积ACK**: ✅ **已修复** - 收到重复包或超前包时，发送对最高按序接收包的累积ACK
- **丢弃乱序包**: 正确丢弃超前到达的包

---

## 二、SR协议检查

### ✅ 发送方 (SrRdtSender.cpp)
- **窗口管理**: 正确实现了滑动窗口，窗口大小为4
- **选择确认**: 正确处理单个包的ACK
- **超时重传**: 正确实现，超时时只重发该包（选择重传的核心特性）
- **定时器管理**: 为每个包维护独立的定时器
- **窗口滑动**: 只有当base包被确认后才滑动窗口
- **滑动窗口输出**: ✅ 已添加，输出滑动前后的窗口状态，显示每个包的ACK状态

### ✅ 接收方 (SrRdtReceiver.cpp)
- **缓存乱序包**: 正确缓存窗口内的乱序包
- **选择ACK**: 对每个正确接收的包都发送ACK
- **按序递交**: 只有连续的包才递交给应用层
- **窗口滑动**: 递交包后正确滑动接收窗口

---

## 三、TCP协议检查

### ✅ 发送方 (TCPRdtSender.cpp)
- **窗口管理**: 正确实现了滑动窗口，窗口大小为4
- **累积确认**: 正确处理累积ACK
- **快速重传**: ✅ 正确实现
  - 收到3个重复ACK时触发快速重传
  - 重复ACK计数逻辑正确：
    * 收到相同ACK时计数加1
    * 收到新ACK时计数重置为0
    * 达到3次重复时触发快速重传
- **超时重传**: 超时时重发base包
- **定时器管理**: 只为base包维护一个定时器
- **滑动窗口输出**: ✅ 已添加，每次窗口滑动时输出窗口内容
- **快速重传输出**: ✅ 已添加，触发快速重传时输出详细提示信息

### ✅ 接收方 (TCPRdtReceiver.cpp)
- **按序接收**: 只接收期望序号的包
- **累积ACK**: ✅ **已修复** - 收到重复包或超前包时，发送对最高按序接收包的累积ACK
- **丢弃乱序包**: 正确丢弃超前到达的包
- **重复ACK生成**: 正确生成重复ACK以触发发送方的快速重传

---

## 四、已修复的问题

### 1. TCP接收方ACK逻辑 ✅
**问题**: 收到重复包时，发送的是对收到包本身的ACK，而不是对最高按序接收包的累积ACK
**修复**: 改为发送 `sendAck(expectedSeqNum - 1)`

### 2. GBN接收方ACK逻辑 ✅
**问题**: 与TCP相同的问题
**修复**: 改为发送对最高按序接收包的累积ACK

### 3. TCP快速重传触发条件 ✅
**确认**: 使用 `lastAckCnt >= 3` 是正确的，表示收到3个重复ACK时触发

### 4. TCP重复ACK计数 ✅
**确认**: 收到新ACK时重置为0是正确的逻辑

### 5. CMakeLists.txt ✅
**问题**: TCP目标使用了SR的源文件
**修复**: 改为使用 `${TCP_SRC}`

---

## 五、编译配置检查

### CMakeLists.txt ✅
- 所有4个协议都正确配置
- 源文件路径正确
- 链接库正确
- 可执行文件输出到 bin/ 目录
- 可执行文件名称：stop_wait, gbn, sr, tcp

---

## 六、输出功能验证

### 滑动窗口输出
- **GBN**: `[GBN] 滑动窗口: base=X, nextSeqNum=Y, 窗口内容: ...`
- **SR**: `[SR] 滑动前窗口: ...` 和 `[SR] 滑动后窗口: ...`
- **TCP**: `[TCP] 滑动窗口: base=X, nextSeqNum=Y, 窗口内容: ...`

### 快速重传输出
- **TCP**: `[TCP] 快速重传触发: 收到3个重复ACK, base=X`

---

## 七、测试建议

### 编译命令
```bash
# 清理旧的构建缓存
rm -rf build

# 重新编译
cmake -S . -B build && cmake --build build --parallel
```

### 运行测试并重定向输出
```bash
# GBN协议测试
./bin/gbn > gbn_output.txt 2>&1

# SR协议测试
./bin/sr > sr_output.txt 2>&1

# TCP协议测试
./bin/tcp > tcp_output.txt 2>&1
```

### 验证要点
1. **GBN**: 检查窗口滑动时是否正确输出窗口内容
2. **SR**: 检查滑动前后窗口状态是否正确显示ACK/NAK标记
3. **TCP**: 
   - 检查窗口滑动输出
   - 检查快速重传触发时的输出
   - 验证是否在收到3个重复ACK后触发快速重传

---

## 八、结论

✅ **所有代码已通过正确性检查**
- 协议逻辑正确
- 滑动窗口实现正确
- TCP快速重传实现正确
- 输出功能已完整添加
- 编译配置正确
- 无语法错误

代码已经完全准备好进行编译和测试。
